<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stocky„ÉÑ - Pagos</title>
  <link rel="stylesheet" href="../styles/dashboard.css">
</head>

<body>

  <!-- Barra superior -->
  <header class="navbar">
    <a class="home-logo" href="../dashboard.html">
      <div class="logo">Stocky„ÉÑ</div>
    </a>
    <nav class="menu">
      <ul>
        <li class="dropdown">
          <a href="#">Inventario ‚ñæ</a>
          <ul class="dropdown-menu">
            <li><a href="../Inventario/productos.html">Productos</a></li>
            <li><a href="../Inventario/categorias.html">Categor√≠as</a></li>
            <li><a href="../Inventario/presentaciones.html">Presentaciones</a></li>
            <li><a href="../Inventario/proveedores.html">Proveedores</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#">Ventas ‚ñæ</a>
          <ul class="dropdown-menu">
            <li><a href="../Ventas/facturas.html">Facturas</a></li>
            <li><a href="../Ventas/registrarVenta.html">Generar Factura</a></li>
            <li><a href="../Ventas/metodoPago.html">M√©todos de Pago</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#">Administraci√≥n ‚ñæ</a>
          <ul class="dropdown-menu">
            <li><a href="../Administracion/vendedores.html">Usuarios</a></li>
            <li><a href="../Administracion/clientes.html">Clientes</a></li>
          </ul>
        </li>
      </ul>
    </nav>

    <button id="logoutBtn">Cerrar Sesi√≥n</button>
  </header>

  <!-- Contenido principal -->

  <main>
    <div class="container">
      <h1>M√©todos de Pago</h1>

      <!-- Panel de Control -->
      <div class="control-panel">
        <div class="search-box">
          <span class="search-icon">üîç</span>
          <input type="text" id="searchInput" placeholder="Buscar m√©todo de pago...">
        </div>
        <button class="btn btn-primary" onclick="openModal('add')">
          ‚ûï Agregar M√©todo de Pago
        </button>
      </div>

      <!-- Tabla de M√©todos de Pago -->
      <div class="table-container">
        <table id="metodosTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>NOMBRE</th>
              <th>ACCIONES</th>
            </tr>
          </thead>
          <tbody id="tableBody">
          </tbody>
        </table>
      </div>
    </div>


    <!-- Modal para Agregar/Editar -->
    <div id="metodoModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Agregar M√©todo de Pago</h2>
          <button class="close-btn" onclick="closeModal()">√ó</button>
        </div>
        <form id="metodoForm">
          <input type="hidden" id="metodoId">
          <div class="form-group">
            <label for="metodoNombre">Nombre del M√©todo de Pago</label>
            <input type="text" id="metodoNombre" required placeholder="Ej: Efectivo, Tarjeta de Cr√©dito, Nequi...">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" onclick="closeModal()">Cancelar</button>
            <button type="submit" class="btn btn-success" id="submitBtn">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    const API_URL = 'http://localhost/stocky/api';
    
    let metodosPago = [];
    let currentEditId = null;

    // Cargar m√©todos de pago desde la API
    async function cargarMetodosPago() {
        try {
            const response = await fetch(`${API_URL}/metodos-pago.php`, {
                credentials: 'include'
            });
            const result = await response.json();

            if (result.success) {
                metodosPago = result.data;
                renderTable();
            } else {
                mostrarError('Error al cargar m√©todos de pago: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarError('Error al cargar m√©todos de pago');
        }
    }

    // Renderizar tabla
    function renderTable(filteredMetodos = metodosPago) {
      const tbody = document.getElementById('tableBody');

      if (filteredMetodos.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="3" class="empty-state">
              <div>
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                </svg>
                <p>No se encontraron m√©todos de pago</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filteredMetodos.map(metodo => `
        <tr>
          <td>${metodo.id}</td>
          <td>${metodo.nombre}</td>
          <td>
            <div class="actions">
              <button class="btn-icon btn-warning" onclick="editMetodo(${metodo.id})" title="Editar">‚úèÔ∏è</button>
              <button class="btn-icon btn-danger" onclick="deleteMetodo(${metodo.id})" title="Eliminar">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Buscar m√©todos de pago
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = metodosPago.filter(metodo =>
        metodo.nombre.toLowerCase().includes(searchTerm) ||
        metodo.id.toString().includes(searchTerm)
      );
      renderTable(filtered);
    });

    // Abrir modal
    function openModal(mode, metodoId = null) {
      const modal = document.getElementById('metodoModal');
      const form = document.getElementById('metodoForm');
      const title = document.getElementById('modalTitle');

      form.reset();
      currentEditId = null;

      if (mode === 'edit' && metodoId) {
        const metodo = metodosPago.find(m => m.id === metodoId);
        if (metodo) {
          title.textContent = 'Editar M√©todo de Pago';
          document.getElementById('metodoId').value = metodo.id;
          document.getElementById('metodoNombre').value = metodo.nombre;
          currentEditId = metodoId;
        }
      } else {
        title.textContent = 'Agregar M√©todo de Pago';
      }

      modal.classList.add('active');
    }

    // Cerrar modal
    function closeModal() {
      document.getElementById('metodoModal').classList.remove('active');
    }

    // Guardar m√©todo de pago
    document.getElementById('metodoForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const nombre = document.getElementById('metodoNombre').value.trim();

      if (currentEditId) {
        // Actualizar
        try {
            const response = await fetch(`${API_URL}/metodos-pago.php`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    id: currentEditId,
                    nombre: nombre
                })
            });
            const result = await response.json();

            if (result.success) {
                mostrarExito('‚úÖ M√©todo de pago actualizado exitosamente');
                await cargarMetodosPago();
                closeModal();
            } else {
                mostrarError('‚ùå ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarError('‚ùå Error al actualizar m√©todo de pago');
        }
      } else {
        // Agregar
        try {
            const response = await fetch(`${API_URL}/metodos-pago.php`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    nombre: nombre
                })
            });
            const result = await response.json();

            if (result.success) {
                mostrarExito('‚úÖ M√©todo de pago agregado exitosamente');
                await cargarMetodosPago();
                closeModal();
            } else {
                mostrarError('‚ùå ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarError('‚ùå Error al agregar m√©todo de pago');
        }
      }
    });

    // Editar m√©todo de pago
    function editMetodo(id) {
      openModal('edit', id);
    }

    // Eliminar m√©todo de pago
    async function deleteMetodo(id) {
      const metodo = metodosPago.find(m => m.id === id);
      if (!confirm(`¬øEst√°s seguro de eliminar el m√©todo de pago "${metodo.nombre}"?`)) {
        return;
      }

      try {
          const response = await fetch(`${API_URL}/metodos-pago.php`, {
              method: 'DELETE',
              headers: {
                  'Content-Type': 'application/json'
              },
              credentials: 'include',
              body: JSON.stringify({
                  id: id
              })
          });
          const result = await response.json();

          if (result.success) {
              mostrarExito('‚úÖ M√©todo de pago eliminado exitosamente');
              await cargarMetodosPago();
          } else {
              mostrarError('‚ùå ' + result.message);
          }
      } catch (error) {
          console.error('Error:', error);
          mostrarError('‚ùå Error al eliminar m√©todo de pago');
      }
    }

    // Cerrar modal al hacer clic fuera
    document.getElementById('metodoModal').addEventListener('click', (e) => {
      if (e.target.id === 'metodoModal') {
        closeModal();
      }
    });

    // Cerrar sesi√≥n
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('¬øEst√°s seguro de cerrar sesi√≥n?')) {
            try {
                await fetch(`${API_URL}/logout.php`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                // Continuar aunque falle
            }
            window.location.href = '../index.html';
        }
    });

    // Funciones auxiliares
    function mostrarExito(mensaje) {
        alert(mensaje);
    }

    function mostrarError(mensaje) {
        alert(mensaje);
    }

    // Inicializar
    cargarMetodosPago();
  </script>

  <footer class="footer">
    <div class="footer-content">
      <div class="footer-section">
        <h3>Stocky„ÉÑ</h3>
        <p>Sistema de gesti√≥n de inventario y ventas para tu negocio.</p>
      </div>

      <div class="footer-section">
        <h4>Enlaces R√°pidos</h4>
        <ul>
          <li><a href="#">Inicio</a></li>
          <li><a href="#">Inventario</a></li>
          <li><a href="#">Ventas</a></li>
          <li><a href="#">Reportes</a></li>
        </ul>
      </div>

      <div class="footer-section">
        <h4>Soporte</h4>
        <ul>
          <li><a href="#">Ayuda</a></li>
          <li><a href="#">Documentaci√≥n</a></li>
          <li><a href="#">Contacto</a></li>
          <li><a href="#">FAQ</a></li>
        </ul>
      </div>

      <div class="footer-section">
        <h4>Contacto</h4>
        <p>üìß info@Stocky.com</p>
        <p>üìû +57 300 123 4567</p>
        <p>üìç Bogot√°, Colombia</p>
      </div>
    </div>

    <div class="footer-bottom">
      <p>&copy; 2025 Stocky„ÉÑ. Todos los derechos reservados.</p>
    </div>
  </footer>

</body>

</html>